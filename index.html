<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anno 1800 Asset Web Viewer</title>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://ajax.aspnetcdn.com/ajax/knockout/knockout-3.5.0.js"></script>

    <script src="extensions.js"></script>
    <script src="items.js"></script>

    <link rel="stylesheet" href="style.css">
    <link rel="shortcut icon" href="AssetViewer/AssetViewer/Resources/AssetViewer.ico" type="image/x-icon">
</head>
<body>
    <main>
        <div style="display: flex; justify-content: space-between; ">
            <div>
                <label for="comboboxAsset">Gegenstand</label>
                <select name="" id="comboboxAsset" data-bind="options: ['Verbesserungen', 'Weltausstellung']"></select>
            </div>
            <div>
                <select name="" id="" data-bind="options: ['Deutsch']"></select>
            </div>
        </div>
    </main>

    <section>
        <!-- Guildhouse Items Tab -->
        <div class="groupbox filters">
            <div>
                <label for="rarityFilter">Seltenheit</label>
                <select name="" id="rarityFilter" data-bind="options: ['']"></select>
            </div>
            <div>
                <label for="equippedFilter">Ausgerüstet in</label>
                <select name="" id="equippedFilter" data-bind="options: ['']"></select>
            </div>
            <div>
                <label for="propertyFilter">Eigenschaft</label>
                <select name="" id="propertyFilter" data-bind="options: ['']"></select>
            </div>
            <div>
                <label for="buildingFilter">Beeinflusst Gebäude</label>
                <select name="" id="buildingFilter" data-bind="options: ['']"></select>
            </div>
            <div>
                <label for="searchFilter">Suchen</label>
                <input type="text" name="" id="searchFilter" />
            </div>
            <div>
                <label for="sortFilter">Sortieren nach</label>
                <select name="" id="sortFilter" data-bind="options: ['Name']"></select>
            </div>
            <div>
                <label for="availableItems">Nur verfügbare Items</label>
                <input type="checkbox" name="" id="availableItems" checked>
            </div>
            <div>
                <label for="" style="display: block;">&nbsp;</label>
                <input type="button" value="Filter zurücksetzen" style="width: 100%;">
            </div>

            <div>
                <input type="button" value="<" id="advancedFiltersBtn" style="width: 20px;">
                <label for="advancedFilterBtn">Erweiterte Filter</label>
            </div>
            <div style="grid-column: 1 / 5;" class="advancedFilters">
                <input type="button" value="-" style="width: 20px;">
                <select name="" id="" data-bind="options: ['Eigenschaft']"></select>
                <select name="" id="" data-bind="options: ['']"></select>
                <select name="" id="" data-bind="options: ['=']"></select>
                <select name="" id="" data-bind="options: ['']"></select>
            </div>
            <div style="grid-column: 1 / 5;" class="advancedFilters">
                <input type="button" value="+" style="width: 20px;">
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr;">
            <!-- Item List -->
            <div class="groupbox itemList">
                <ul style="list-style-type: none; padding: 0; margin: 2px;" data-bind="foreach: items().sort(sortByLocalizedText)">
                    <li style="display: flex; justify-content: space-between;" data-bind="attr: { itemId: id }, visible: isFiltered($data)">
                        <img style="width: 24px; height: 24px;" data-bind="attr: { src: 'AssetViewer/AssetViewer/Resources/' + text.icon }">
                        <div data-bind="text: localize(id)?.text ?? name"></div>
                        <div data-bind="text: id"></div>
                    </li>
                </ul>
            </div>

            <!-- Item Card -->
            <div class="groupbox itemview"
            data-bind="with: selectedItem, style: { borderColor: 'rgba(255, 85, 70, 0.157)', backgroundImage: 'linear-gradient(' + rarityColor(selectedItem().rarityType) + ' 0%, rgb(42, 44, 39) 20%)' }">
                <div class="itemcard-head">
                    <img style="width: 75px;" data-bind="attr: { src: 'AssetViewer/AssetViewer/Resources/' + text.icon }">
                    <div class="itemcard-title">
                        <div style="color: #FFFFE4AD; font-weight: bold; font-size: 16px;" data-bind="text: localize(id)?.text"></div>
                        <div data-bind="text: localize(rarity.id)?.text"></div>
                    </div>
                </div>
                <div class="itemcard-body">
                    <div class="itemcard-information" style="display: flex;">
                        <img data-bind="attr: { src: 'AssetViewer/AssetViewer/Resources/' + allocation.text.icon }">
                        <div style="color: #FFFFE4AD;" data-bind="text: localize(-106)?.text">Ausgerüstet in</div>
                        <div style="font-weight: bold; color: #f7c743" data-bind="text: localize(allocation.text.id)?.text"></div>
                    </div>
                    
                    <div class="itemcard-information" data-bind="visible: hasTargetInfo">
                        <div data-bind="text: localize(-1210)?.text + effectTargets.map(t => localize(t.text.id)?.text).distinct().joinClose(', ', 'und')"></div>
                    </div>
                    <div class="itemcard-information" style="border: none;" data-bind="foreach: genericUpgrades">
                        <div class="itemcard-upgrade">
                            <img data-bind="attr: { src: 'AssetViewer/AssetViewer/Resources/' + text.icon }">
                            <div data-bind="text: localize(text.id)?.text"></div>
                            <div data-bind="text: value"></div>
                        </div>
                    </div>

                    <!-- Transmute -->
                    <div class="itemcard-information" data-bind="visible: craftableItemUpgrades">
                        <div data-bind="text: localize(113817)?.text" style="margin-bottom: 5px;"></div>
                        <div class="itemcard-upgrade" data-bind="foreach: craftableItemUpgrades">
                            <img data-bind="attr: { src: 'AssetViewer/AssetViewer/Resources/' + text.icon }">
                            <div data-bind="text: localize(text.id)?.text"></div>
                            <div data-bind="text: value"></div>
                        </div>
                    </div>

                    <!-- Trade -->
                    <div class="itemcard-information" style="display: block;">
                        <div class="itemcard-upgrade">
                            <img data-bind="attr: { src: 'AssetViewer/AssetViewer/Resources/data/ui/2kimages/main/icons/icon_credits.png' }">
                            <div data-bind="text: localize(12725)?.text"></div>
                            <div data-bind="text: parseInt(tradePrice).toLocaleString()"></div>
                        </div>
                    </div>

                    <!-- Info -->
                    <div class="itemcard-information">
                        <div data-bind="text: localize(info.id)?.text" style="font-style: italic; margin-right: 0;"></div>
                    </div>
                </div>
            </div>
        </div>

    </section>
    <script>
        
        function localize(id) {
            return localization.find(l => l.id == id);
        }

        function unlocalize(text) {
            return localization.filter(l => l.text.includes(text))
        }

        function sortByLocalizedText(a, b) {
            let aText = localize(a.text.id)?.text;
            let bText = localize(b.text.id)?.text;
            if (aText > bText) return 1;
            if (aText < bText) return -1;
            return 0;
        }

        function rarityColor(rarityType) {
            switch(rarityType) {
                case "Uncommon":
                    return 'rgb(65, 89, 41)';
                case "Rare":
                    return 'rgb(50, 60, 83)';
                case "Epic":
                    return 'rgb(90, 65, 89)';
                case "Legendary":
                    return 'rgb(98, 66, 46)';
                default:
                    return 'rgb(126, 128, 125)';
            }
        }

        function getItemById(id) {
            return view.items().find(item => item.id == id);
        }

        let once = false;

        function isFiltered(item = undefined) {
            if (item == undefined)
                return false;
                
            if (!once)
                console.log(item);
            once = true;

            let rarity = item.rarity.id == conditions.rarity || conditions.rarity == null;
            let hosted = item.hosted == conditions.hosted || conditions.hosted == null;
            let property = item.property == conditions.property || conditions.property == null;
            let target = item.target == conditions.target || conditions.target == null;
            let name = item.name == conditions.name || conditions.name == null;
            let isAvailable = item.isAvailable == conditions.isAvailable || conditions.isAvailable == null;

            return rarity && hosted && property && target && name && isAvailable && item.itemType == 'Item';
            
            return true;
        }

        // Aesop 639
        // Fjordbuster 822

        const allItems = items.map(item => {
            // correct allocation icons
            if (item.allocation) {
                switch (item.allocation.text.id) {
                    case '2346':
                        item.allocation.text.icon = "data/ui/2kimages/main/3dicons/icon_guildhouse.png"
                        break;
                    case '4065':
                        item.allocation.text.icon = "data/ui/2kimages/main/3dicons/icon_harbour_kontor.png"
                        break;
                    case '2347':
                        item.allocation.text.icon = "data/ui/2kimages/main/3dicons/icon_townhall.png";
                        break;
                    case '115353':
                        item.allocation.text.icon = "data/ui/2kimages/main/3dicons/icon_community_lodge.png";
                }
            }
            return item;
        });

        let conditions = {
            rarity: 118006,
            hosted: null,
            property: null,
            target: null,
            name: null,
            isAvailable: null
        };

        var view = {
            items: ko.observableArray(allItems.filter(x => x.sources != null)),
            selectedItem: ko.observable(items[822]),
        };

        ko.applyBindings(view);

        document.querySelectorAll('li').forEach(element => element.addEventListener('click', e => {
            let id = e.path.find(elem => elem.tagName == 'LI').getAttribute('itemId');
            view.selectedItem(getItemById(id));
        }));
    </script>
</body>
</html>
